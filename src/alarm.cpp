#include <A_Config.h>
#include <alarm.h>
#include <LittleFS.h>

Alarm alarms;

void Alarm::load()
{
    // 从LittleFS加载
    if (LittleFS.exists("/alarms.bin") == false)
    {
        clearAll();
        save();
        return;
    }
    File f = LittleFS.open("/alarms.bin");
    f.readBytes((char *)alarm_table, sizeof(alarm_table));
    f.close();
}

void Alarm::save()
{
    File f = LittleFS.open("/alarms.bin", "w");
    f.write((uint8_t *)alarm_table, sizeof(alarm_table));
    f.close();
}

int8_t Alarm::getNext(uint16_t week, uint16_t now)
{
    uint16_t bit_week = BIT(week);
    int next = -1;
    uint16_t next_time = 0;
    for (int i = 0; i < 5; ++i)
    {
        if ((alarm_table[i].enable & bit_week) || (alarm_table[i].enable & 0x80))
        {
            if (alarm_table[i].time > now)
            {
                if (next == -1)
                {
                    next = i;
                    next_time = alarm_table[i].time;
                }
                else
                {
                    if (alarm_table[i].time < next_time)
                    {
                        next = i;
                        next_time = alarm_table[i].time;
                    }
                }
            }
        }
    }
    return next;
}

#define alarm_clock_width 120
#define alarm_clock_height 120

static const unsigned char alarm_clock_bits[] = {
    0x00, 0x00, 0xfc, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0,
    0x3f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xfe, 0xff, 0x03, 0x00, 0x00, 0xf0, 0xff, 0xff, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x0f, 0x00, 0x00, 0xfc, 0xff,
    0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0x3f, 0x00,
    0x00, 0xfe, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff,
    0xff, 0x7f, 0x00, 0x00, 0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xf8, 0xff, 0xff, 0xff, 0x00, 0x80, 0xff, 0xff, 0xff, 0x1f, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0x01, 0xc0, 0xff, 0xff,
    0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff, 0x03,
    0xe0, 0xff, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff,
    0xff, 0xff, 0x07, 0xf0, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xc0, 0xff, 0xff, 0xff, 0x0f, 0xf8, 0xff, 0xff, 0xff, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff,
    0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0x1f,
    0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc,
    0xff, 0xff, 0x3f, 0xfc, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xf8, 0xff, 0xff, 0x3f, 0xfe, 0xff, 0xff, 0x0f, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0x7f, 0xfe, 0xff, 0xff,
    0x03, 0x00, 0x00, 0xe0, 0xff, 0x07, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x7f,
    0xfe, 0xff, 0xff, 0x01, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x80,
    0xff, 0xff, 0x7f, 0xfe, 0xff, 0xff, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff,
    0x0f, 0x00, 0x00, 0xff, 0xff, 0x7f, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfe,
    0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x3f,
    0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0xfc, 0xff, 0xff,
    0xff, 0xff, 0x0f, 0x00, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0x00,
    0xf0, 0xff, 0xff, 0xff, 0xff, 0x07, 0x00, 0xf8, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x1f, 0x00, 0xe0, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00, 0xfe, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x01,
    0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0x80, 0xff, 0xff,
    0xff, 0xff, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03,
    0x00, 0xff, 0xff, 0xff, 0x3f, 0x00, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x07, 0x00, 0xfc, 0xff, 0xff, 0x1f, 0x00, 0xf8, 0xff, 0xff,
    0xff, 0x00, 0xff, 0xff, 0xff, 0x1f, 0x00, 0xf8, 0xff, 0xfe, 0x0f, 0x00,
    0xfc, 0xff, 0xff, 0x03, 0x00, 0xc0, 0xff, 0xff, 0x3f, 0x00, 0xf0, 0x7f,
    0xfe, 0x07, 0x00, 0xfe, 0xff, 0x7f, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x7f,
    0x00, 0xe0, 0x7f, 0xfe, 0x03, 0x00, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x00,
    0xf0, 0xff, 0xff, 0x00, 0xc0, 0x7f, 0xfc, 0x00, 0x80, 0xff, 0xff, 0x03,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x01, 0x00, 0x3f, 0x7c, 0x00, 0xc0,
    0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x03, 0x00, 0x3e,
    0x3c, 0x00, 0xe0, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff,
    0x07, 0x00, 0x3c, 0x18, 0x00, 0xf0, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xf8, 0xff, 0x0f, 0x00, 0x18, 0x00, 0x00, 0xf8, 0xff, 0x07, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xfc,
    0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x3f, 0x00, 0x00,
    0x00, 0x00, 0xfc, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff,
    0x3f, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0xff, 0x7f, 0x00, 0x00,
    0x80, 0xff, 0x01, 0x00, 0x00, 0xfe, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff,
    0x3f, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0xfc, 0xff, 0x00, 0x00,
    0x00, 0x80, 0xff, 0x1f, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0xf8,
    0xff, 0x01, 0x00, 0x00, 0xc0, 0xff, 0x0f, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0xf0, 0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0x07, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0xe0, 0xff, 0x03, 0x00, 0x00, 0xe0, 0xff,
    0x03, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0xe0, 0xff, 0x07, 0x00,
    0x00, 0xe0, 0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0xc0,
    0xff, 0x07, 0x00, 0x00, 0xf0, 0xff, 0x01, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0x80, 0xff, 0x0f, 0x00, 0x00, 0xf0, 0xff, 0x01, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0x80, 0xff, 0x0f, 0x00, 0x00, 0xf8, 0xff,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xff, 0x1f, 0x00,
    0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00,
    0xfe, 0x1f, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xfc, 0x3f,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xfc, 0x3f, 0x00,
    0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00,
    0xfc, 0x3f, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0xfe, 0x1f,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xf8, 0x7f, 0x00,
    0x00, 0xfe, 0x0f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00,
    0xf0, 0x7f, 0x00, 0x00, 0xff, 0x0f, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0x00, 0xf0, 0xff, 0x00, 0x00, 0xff, 0x0f, 0x00, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x00, 0x00, 0xff, 0x0f,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xf0, 0xff, 0x00,
    0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00,
    0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x00,
    0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00,
    0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03,
    0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00,
    0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07,
    0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x00,
    0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x03, 0x00, 0x00, 0x00,
    0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x07,
    0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00,
    0xc0, 0xff, 0x0f, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07,
    0x00, 0x00, 0x00, 0x80, 0xff, 0x1f, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x00,
    0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0x80, 0xff, 0x7f, 0x00, 0x00, 0x00,
    0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff,
    0x00, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 0x00, 0x00,
    0x00, 0xff, 0xff, 0x01, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x0f,
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x03, 0x00, 0x00, 0xf0, 0xff, 0x00,
    0x00, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x0f, 0x00, 0x00,
    0xf0, 0xff, 0x00, 0x00, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff,
    0x1f, 0x00, 0x00, 0xf0, 0x7f, 0x00, 0x00, 0xfe, 0x0f, 0x00, 0x00, 0x00,
    0x00, 0xf0, 0xff, 0x3f, 0x00, 0x00, 0xf0, 0x7f, 0x00, 0x00, 0xfe, 0x1f,
    0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x7f, 0x00, 0x00, 0xf8, 0x7f, 0x00,
    0x00, 0xfe, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x00, 0x00,
    0xf8, 0x7f, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,
    0xff, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0xfc, 0x3f, 0x00, 0x00, 0xfc, 0x3f,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x7f, 0x00, 0x00, 0xfc, 0x3f, 0x00,
    0x00, 0xfc, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x3f, 0x00, 0x00,
    0xfc, 0x3f, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0,
    0x1f, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0xf8, 0x7f, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xc0, 0x0f, 0x00, 0x00, 0xfe, 0x1f, 0x00, 0x00, 0xf8, 0xff,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x07, 0x00, 0x00, 0xff, 0x0f, 0x00,
    0x00, 0xf0, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x80,
    0xff, 0x0f, 0x00, 0x00, 0xf0, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x80, 0xff, 0x0f, 0x00, 0x00, 0xe0, 0xff, 0x03, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x07, 0x00, 0x00, 0xe0, 0xff,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff, 0x07, 0x00,
    0x00, 0xc0, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0,
    0xff, 0x03, 0x00, 0x00, 0xc0, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xf0, 0xff, 0x03, 0x00, 0x00, 0x80, 0xff, 0x1f, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x01, 0x00, 0x00, 0x00, 0xff,
    0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x00, 0x00,
    0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe,
    0xff, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xfe,
    0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0x7f, 0x00, 0x00,
    0x00, 0x00, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xff,
    0xff, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xf8, 0xff, 0xff, 0x01, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x3f, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x03, 0x00, 0x00, 0xe0, 0xff,
    0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x07, 0x00,
    0x00, 0xf0, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff,
    0xff, 0x0f, 0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x00,
    0xf0, 0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0xfc, 0xff, 0xff, 0xff, 0x7f,
    0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0x3f, 0x00, 0x00, 0xfe, 0xff,
    0xff, 0xff, 0xff, 0x03, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00,
    0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xcf, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff,
    0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0x00,
    0x00, 0xff, 0xff, 0x03, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xc0,
    0xff, 0xff, 0x00, 0x00, 0xfe, 0xff, 0x01, 0xf8, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x1f, 0x80, 0xff, 0x7f, 0x00, 0x00, 0xfe, 0xff, 0x00, 0xe0, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x07, 0x00, 0xff, 0x7f, 0x00, 0x00, 0xfc, 0x7f,
    0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0xfe, 0x3f, 0x00,
    0x00, 0xf8, 0x3f, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00,
    0xfc, 0x1f, 0x00, 0x00, 0xf0, 0x1f, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff,
    0x0f, 0x00, 0x00, 0xf8, 0x0f, 0x00, 0x00, 0xe0, 0x0f, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xf0, 0x07, 0x00, 0x00, 0x80, 0x03,
    0x00, 0x00, 0x00, 0xe0, 0xff, 0x07, 0x00, 0x00, 0x00, 0xc0, 0x01, 0x00};

void Alarm::alarm()
{
    String filename = hal.pref.getString(SETTINGS_PARAM_ALARM_TONE, "");
    bool beep = false;
    if (filename == "")
    {
        beep = true;
        buzzer.append(2000, 500);
    }
    else
    {
        beep = false;
        buzzer.playFile(filename.c_str());
    }
    display.clearScreen();
    display.drawXBitmap(88, 4, alarm_clock_bits, alarm_clock_width, alarm_clock_height, 0);
    display.display();
    for (int16_t i = 0; i < 600; ++i)
    {
        if (digitalRead(PIN_BUTTONC) == 0)
        {
            break;
        }
        delay(100);
        if (beep == true)
        {
            if (i % 5 == 0)
            {
                buzzer.append(2000, 500);
            }
        }
    }
    buzzer.forceStop();
    display.clearScreen();
    display.display(true);
}

int8_t RTC_DATA_ATTR next_alarm_to = -1;
// 闹钟检查原理
// next_alarm_to如果不是0：说明上次启动已经判断过下次时间
// 如果是0,则更新下次闹钟时间
void Alarm::check()
{
    if (next_alarm_to == -1)
    {
        int8_t nextIdx = getNext(hal.timeinfo.tm_wday, hal.timeinfo.tm_hour * 60 + hal.timeinfo.tm_min);
        if (nextIdx != -1)
        {
            // 今天有闹钟
            next_alarm_to = nextIdx;
        }
    }
    else
    {
        int8_t tmp = getNext(hal.timeinfo.tm_wday, hal.timeinfo.tm_hour * 60 + hal.timeinfo.tm_min);
        if (tmp != next_alarm_to)
        {
            alarm();
            if((alarm_table[next_alarm_to].enable == 0))
            {
                alarm_table[next_alarm_to].enable = ALARM_DISABLE;
                save();
            }
            next_alarm_to = tmp;
        }
    }
}

int Alarm::getNextWakeupMinute()
{
    if (next_alarm_to != -1)
        return alarm_table[next_alarm_to].time;
    return 0;
}

extern const char *dayOfWeek[];
String Alarm::getEnable(alarm_t *alarm)
{
    if (alarm->enable == 0)
        return "关";
    if (alarm->enable == 0x80)
        return "单次";
    if (alarm->enable == 0x7F)
        return "每天";
    if (alarm->enable == 0b00111110)
        return "周一到周五";
    if (alarm->enable == 0b01000001)
        return "周六和周日";
    String result = "";
    for (uint8_t i = 0; i < 7; ++i)
    {
        if (BIT(i) & alarm->enable)
        {
            result += dayOfWeek[i];
        }
    }
    return result;
}
